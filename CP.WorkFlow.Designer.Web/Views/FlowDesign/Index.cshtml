@{
    ViewData["Title"] = "流程设计页面";
    Layout = null;
}

<!DOCTYPE html>
<html>
<head>
    <title>HTML5 Diagram Sample Application by Kendo UIÂ®</title>

    <link href="~/lib/Content/css/kendo.common.min.css" rel="stylesheet" />
    <link href="~/lib/Content/css/kendo.rtl.min.css" rel="stylesheet" />
    <link href="~/lib/Content/css/kendo.metro.min.css" rel="stylesheet" />    
    <script src="~/lib/Content/js/jquery-1.12.3.min.js"></script>
    <script src="~/lib/Content/js/angular.js"></script>
    <script src="~/lib/Content/js/jszip.min.js"></script>
    <script src="~/lib/Content/js/react.js"></script>
    <script src="~/lib/Content/js/react-dom.js"></script>
    <script src="~/lib/Content/js/kendo.all.min.js"></script>
    <script src="~/lib/Content/js/kendo.timezones.min.js"></script>    
    
    <link href="~/lib/Content/css/styles.css" rel="stylesheet" />



</head>
<body>
    <!-- Google Tag Manager -->
    <noscript>
        <iframe src="https://www.googletagmanager.com/ns.html?id=GTM-6X92" height="0" width="0" style="display: none; visibility: hidden"></iframe>
    </noscript>
    <script>(function(w, d, s, l, i) { w[l] = w[l] || []; w[l].push({ 'gtm.start': new Date().getTime(), event: 'gtm.js' }); var f = d.getElementsByTagName(s)[0], j = d.createElement(s), dl = l != 'dataLayer' ? '&l=' + l : ''; j.async = true; j.src = '//www.googletagmanager.com/gtm.js?id=' + i + dl; f.parentNode.insertBefore(j, f); })(window, document, 'script', 'dataLayer', 'GTM-6X92');</script>
    <!-- End Google Tag Manager -->
    <div id="menu">
        <div class="header">
            示意图
            <a id="about">关于</a>
        </div>
        <ul></ul>
    </div>
    <div id="splitter">
        <div id="left-pane">
            <div class="pane-content">
                <ul id="shapesPanelBar">
                    <li>
                        基础图形
                        <ul>
                            <li>
                                <span class="shapeItem" data-shape='{"width":120,"height":120,"type":"rectangle"}' style="background-position: 0 0"></span>
                                <span>正方形</span>
                            </li>
                            <li>
                                <span class="shapeItem" data-shape='{"type":"circle","width":120,"height":120}' style="background-position: -60px 0"></span>
                                <span>圆形</span>
                            </li>
                            <li>
                                <span class="shapeItem" data-shape='{"width":120,"height":80,"type":"rectangle"}' style="background-position: -120px 0"></span>
                                <span>长方形</span>
                            </li>
                            <li>
                                <span class="shapeItem" data-shape='{"type":"circle","width":120,"height":80}' style="background-position: -180px 0"></span>
                                <span>椭圆形</span>
                            </li>
                        </ul>
                    </li>
                    <li>
                        多边形
                        <ul>
                            <li>
                                <span class="shapeItem" data-shape='{"path":"M 60,0 L120,44 L97,114 L23,114 L0,44 z"}' style="background-position: -240px 0"></span>
                                <span>五边形</span>
                            </li>
                            <li>
                                <span class="shapeItem" data-shape='{"path":"m30,0 L90,0 L120,52 L90,104 L30,104 L0,52 z"}' style="background-position: -300px 0"></span>
                                <span>六边形</span>
                            </li>
                            <li>
                                <span class="shapeItem" data-shape='{"path":"m60,0 L108.12,23.17 L120,75.24 L86.7,116.99 L33.3,116.99 L0,75.24 L11.88,23.17 z"}' style="background-position: -360px 0"></span>
                                <span>七边形</span>
                            </li>
                            <li>
                                <span class="shapeItem" data-shape='{"path":"m35.15,0 L84.85,0 L120,35.15 L120,84.85 L84.85,120 L35.15,120 L0,84.85 L0,35.15 z"}' style="background-position: -420px 0"></span>
                                <span>八边形</span>
                            </li>
                        </ul>
                    </li>
                    <li>
                        箭头
                        <ul>
                            <li>
                                <span class="shapeItem" data-shape='{"path":"m0,20 L20,0 L20,10 L120,10 L120,30 L20,30 L20,40 z"}' style="background-position: -480px 0"></span>
                                <span>45度</span>
                            </li>
                            <li>
                                <span class="shapeItem" data-shape='{"path":"m0,20 L11.5,0 L11.5,10 L120,10 L120,31 L11.5,31 L11.5,40 z"}' style="background-position: -540px 0"></span>
                                <span>60度</span>
                            </li>
                        </ul>
                    </li>
                </ul>
            </div>
        </div>
        <div id="center-pane">
            <div class="pane-content">
                <div id="diagram"></div>
            </div>
        </div>
        <div id="right-pane">
            <div class="pane-content">
                <ul id="configurationPanelBar">
                    <li>
                        画布属性
                        <div id="canvasProperties">
                            <ul>
                                <li>
                                    <span>背景颜色:</span>
                                    <input id="canvasBackgroundColorPicker" class="colorPicker" />
                                </li>
                                <li>
                                    <span>布局:</span>
                                    <input id="canvasLayout" />
                                </li>
                            </ul>
                        </div>
                    </li>
                    <li>
                        图形属性
                        <div id="shapeProperties">
                            <ul>
                                <li>
                                    <span>背景颜色:</span>
                                    <input id="shapeBackgroundColorPicker" class="colorPicker" />
                                </li>
                                <li>
                                    <span>描边颜色:</span>
                                    <input id="shapeStrokeColorPicker" class="colorPicker" />
                                </li>
                                <li>
                                    <span>描边宽度:</span>
                                    <input type="text" id="shapeStrokeWidth" class="numeric" />
                                </li>
                                <li>
                                    <span>宽度:</span>
                                    <input type="text" id="shapeWidth" class="numeric" />
                                </li>
                                <li>
                                    <span>高度:</span>
                                    <input type="text" id="shapeHeight" class="numeric" />
                                </li>
                                <li>
                                    <span>位置X:</span>
                                    <input type="text" id="shapePositionX" class="numeric" />
                                </li>
                                <li>
                                    <span>位置Y:</span>
                                    <input type="text" id="shapePositionY" class="numeric" />
                                </li>
                            </ul>
                        </div>
                    </li>
                    <li>
                        连接属性
                        <div id="connectionProperties">
                            <ul>
                                <li>
                                    <span>开始上限:</span>
                                    <input id="connectionStartCap" />
                                </li>
                                <li>
                                    <span>结束上限:</span>
                                    <input id="connectionEndCap" />
                                </li>
                            </ul>
                        </div>
                    </li>
                    <li>
                        对齐
                        <div id="alignConfiguration" style="width: 100%; padding: 10px; box-sizing: border-box; text-align: left;">
                            <button class="configurationButtons" data-position="top">
                                <span class="alignTop"></span>
                            </button><button class="configurationButtons" data-position="bottom">
                                <span class="alignBottom"></span>
                            </button><button class="configurationButtons" data-position="left">
                                <span class="alignLeft"></span>
                            </button><button class="configurationButtons" data-position="right">
                                <span class="alignRight"></span>
                            </button>
                        </div>
                    </li>
                    <li>
                        排列
                        <div id="arrangeConfiguration">
                            <div style="width: 100%; padding: 10px; box-sizing: border-box; text-align: left;">
                                <button class="configurationButtons">
                                    <span class="toFront"></span>
                                </button><button class="configurationButtons">
                                    <span class="toBack"></span>
                                </button>
                            </div>
                        </div>
                    </li>
                </ul>
            </div>
        </div>
    </div>
    <div id="bottom-box">
        <input id="diagramZoom" />
        <input type="text" id="diagramZoomIndicator" class="k-textbox" value="100" style="width: 40px; vertical-align: middle;" />
    </div>

    <div id="window">
        <h2>HTML5 Diagram Sample Application by Progress</h2>

        <p>The Diagramming Tool app was built with HTML5 Kendo UI widgets. Kendo UI framework consists of <a href="http://www.telerik.com/kendo-ui#Widgets">70+ UI widgets</a> that take care of the common functionality of your application, while leaving you with more time to work on its business logic.</p>
        <p>The app demonstrates the Diagram widget functionality and its integration with numerous other Telerik components. The source code is available so you can use it as a base for implementing your custom scenario.</p>
        <p>The sample app enables users to modify, add, remove and connect shapes. Once they are happy with the diagram they have created, they can save it to a file and load it back later.</p>
        <p>Make sure you try the various built-in layouts of the Diagram control showcased in the sample.</p>
        <h3>Featured Kendo UI Widgets</h3>
        <ul>
            <li><a href="http://www.telerik.com/kendo-ui/web-button">Button</a></li>
            <li><a href="http://www.telerik.com/kendo-ui/colorpicker">Color Picker</a></li>
            <li><a href="http://www.telerik.com/kendo-ui/diagram">Diagram</a></li>
            <li><a href="http://demos.telerik.com/kendo-ui/web/dragdrop/index.html">Drag & Drop</a></li>
        </ul>
        <ul>
            <li><a href="http://www.telerik.com/kendo-ui/dropdownlist">DropDownList</a></li>
            <li><a href="http://www.telerik.com/kendo-ui/menu">Menu</a></li>
            <li><a href="http://www.telerik.com/kendo-ui/numerictextbox">Numeric TextBox</a></li>
            <li><a href="http://www.telerik.com/kendo-ui/panelbar">PanelBar</a></li>
        </ul>
        <ul>
            <li><a href="http://www.telerik.com/kendo-ui/splitter">Splitter</a></li>
            <li><a href="http://www.telerik.com/kendo-ui/slider">Slider</a></li>
            <li><a href="http://www.telerik.com/kendo-ui/upload">Upload</a></li>
            <li><a href="http://www.telerik.com/kendo-ui/window">Window</a></li>
        </ul>

        <p>Copyright &copy; 2018, Progress Software Corporation and/or its subsidiaries or affiliates. All Rights Reserved.</p>
    </div>

    <script>
        $(function () {
            //定义字段
            var Shape = kendo.dataviz.diagram.Shape,//创建图形
                Connection = kendo.dataviz.diagram.Connection,//创建连接线
                Rect = kendo.dataviz.diagram.Rect,//创建形状
                Point = kendo.dataviz.diagram.Point,//创建点
                selected;//创建已选择的项

            $("#canvasProperties").on("change", canvasPropertiesChange);

            var layoutMapping = {
                "TreeDown": {
                    type: "tree",
                    subtype: "down"
                },
                "TreeUp": {
                    type: "tree",
                    subtype: "up"
                },
                "TreeLeft": {
                    type: "tree",
                    subtype: "left"
                },
                "TreeRight": {
                    type: "tree",
                    subtype: "right"
                },
                "RadialTree": {
                    type: "tree",
                    subtype: "radial"
                },
                "TipOverTree": {
                    type: "tree",
                    subtype: "typeover"
                },
                "LayeredHorizontal": {
                    type: "layered",
                    subtype: "horizontal"
                },
                "LayeredVertical": {
                    type: "layered",
                    subtype: "vertial"
                },
                "ForceDirected": {
                    type: "force",
                    subtype: "directed"
                },
                "MindmapVertical": {
                    type: "tree",
                    subtype: "mindmapvertical"
                },
                "MindmapHorizontal": {
                    type: "tree",
                    subtype: "mindmaphorizontal"
                }
            };

            //画布属性改变时
            function canvasPropertiesChange() {
                diagram.element.css(
                    "background-color",
                    $("#canvasBackgroundColorPicker").getKendoColorPicker().value());//获取画布颜色

                //设置为画布背景色
                var layout = layoutMapping[$("#canvasLayout").getKendoDropDownList().value()];

                diagram.layout({
                    type: layout.type,
                    subtype: layout.subtype,
                    animation: true
                });
            }

            //图形属性改变时
            $("#shapeProperties").on("change", shapePropertiesChange);

            //图形属性改变时属性方法
            function shapePropertiesChange() {
                var elements = selected || [],//定义元素数据
                    options = {
                        fill: $("#shapeBackgroundColorPicker").getKendoColorPicker().value(),//图形颜色选择器
                        stroke: {
                            color: $("#shapeStrokeColorPicker").getKendoColorPicker().value(),//图形的描边颜色
                            width: $("#shapeStrokeWidth").getKendoNumericTextBox().value()//图形描边宽度
                        }
                    },
                    bounds = new Rect(//重新纠正位置
                        $("#shapePositionX").getKendoNumericTextBox().value(),//图形的坐标X
                        $("#shapePositionY").getKendoNumericTextBox().value(),//图形的坐标Y
                        $("#shapeWidth").getKendoNumericTextBox().value(),//图形的宽度
                        $("#shapeHeight").getKendoNumericTextBox().value()//图形的高度
                    ),
                    element, i;//定义

                for (i = 0; i < elements.length; i++) {
                    element = elements[i];
                    if (element instanceof Shape) {//true 实例element在不在Shape构造函数中
                        element.redraw(options);//重画颜色

                        element.bounds(bounds);//重绑边界
                    }
                }
            }

            //连接线属性改变
            function connectionPropertiesChange() {
                var elements = selected || [],//定义元素组
                    options = {
                        startCap: $("#connectionStartCap").getKendoDropDownList().value(),//开始上限值
                        endCap: $("#connectionEndCap").getKendoDropDownList().value()//结束上限值
                    },
                    element;//定义

                for (i = 0; i < elements.length; i++) {
                    element = elements[i];
                    if (element instanceof Connection) {//判断element在不在Connection构造函数内
                        element.redraw(options);//重画
                    }
                }
            }
            //连接线的属性改变时
            $("#connectionProperties").on("change", connectionPropertiesChange);

            //kendo 绑定按钮时间
            $("#alignConfiguration .configurationButtons").kendoButton({//对齐方式下的按钮点击
                click: function(e) {
                    var value = this.element.data("position");
                    diagram.alignShapes(value);//形状对齐
                }
            });

            $("#arrangeConfiguration .configurationButtons").kendoButton({
                click: function (e) {
                    var methodName = this.element.find("span").attr("class");
                    diagram[methodName]();
                }
            });

            $("#diagramZoomIndicator").change(function() {
                var value = $(this).val();
                $("#diagramZoom").getKendoSlider().value(value);
                diagram.zoom(value);
            });

            //清空
            function reset() {
                diagram.clear();
            }

            //撤回
            function undo() {
                diagram.undo();
            }

            //重做
            function redo() {
                diagram.redo();
            }

            //复制
            function copyItem() {
                diagram.copy();
            }

            //粘贴
            function pasteItem() {
                diagram.paste();
            }

            //菜单对应的执行动作
            var actions = {
                "空白页": reset,
                "撤回": undo,
                "重做": redo,
                "复制": copyItem,
                "粘贴": pasteItem
            };

            //菜单
            $("#menu ul").kendoMenu({
                dataSource: [
                    { text: "新建", spriteCssClass: "new-item", items: [
                        { text: "空白页", spriteCssClass: "blank-item", cssClass: "active" }
                        ]
                    },
                    { text: "打开<input id='upload' type='file' name='files' />", encoded: false, spriteCssClass: "open-item", cssClass: "upload-item" },
                    { text: "保存<a id='export' download='diagram.json'></a>", encoded: false, spriteCssClass: "save-item" },
                    { text: "撤回", spriteCssClass: "undo-item", cssClass: "active" },
                    { text: "重做", spriteCssClass: "redo-item", cssClass: "active" },
                    { text: "复制", spriteCssClass: "copy-item", cssClass: "active" },
                    { text: "粘贴", spriteCssClass: "paste-item", cssClass: "active" }
                ],
                select: function(e) {
                    var item = $(e.item),
                        itemText = item.children(".k-link").text();

                    if (!item.hasClass("active")) {
                        return;
                    }
                    actions[itemText.charAt(0).toLowerCase() + itemText.slice(1)]();
                }
            });

            //保存导出
            $("#export").on("click", function() {
                var json = JSON.stringify(diagram.save()),
                    blob = new Blob([json], {type: "application\/json"});;
                
                //浏览器下载方式
                if (navigator.msSaveBlob) {
                    navigator.msSaveBlob(blob, this.getAttribute("download"));
                } else {
                    this.href = window.URL.createObjectURL(blob);
                }
            });

            //打开上传--TODO:待调试
            $("#upload").kendoUpload({
                async: {
                    saveUrl: "save",//保存的url，即调用的接口
                    removeUrl: "remove",
                    autoUpload: true
                },
                showFileList: false,
                localization: {
                    select: ""
                },
                select: function(e) {
                    if (typeof (FileReader) !== "undefined") {
                        var f = e.files[0].rawFile,
                            reader = new FileReader;

                        reader.onload = (function(file) {
                            return function(e) {
                                diagram.load(JSON.parse(e.target.result));
                            };
                        })(f);

                        reader.readAsBinaryString(f);
                    }
                }
            });

            //窗格配置
            $("#splitter").kendoSplitter({
                panes: [
                    { collapsible: true, size: "200px" },//第一个窗格可调整，且宽度为200px
                    { collapsible: false, scrollable: false },//第二个窗格不能调整，且没有滚动条
                    { collapsible: true, size: "300px" }//第三个窗格可调整，且宽度为300px
                ]
            });


            //初始化设计框

            var diagram = $("#diagram").kendoDiagram({
                theme: "default",//主体默认
                dataSource: {//数据源--TODO：需要调整
                    data: [{
                        name: "0",
                        items: [{
                            name: "0"
                        }]
                    }],
                    schema: {//映射
                        model: {
                            children: "items"
                        }
                    }
                },
                shapeDefaults: {//图形默认
                    width: 120,
                    height: 120,
                    fill: "#8ebc00"
                },
                layout: {//布局
                    type: "tree",
                    subtype: "right"
                },
                select: function(e) {//选择时
                    if (e.selected.length) {
                        selected = e.selected;
                        var element = e.selected[0];
                        if (element instanceof Shape) {//element 属于Shape，则返回true
                            updateShapeProperties(element.options);
                        } else {
                            updateConnectionProperties(element.options);
                        }
                    }
                },
                editable: {//图形是否可编辑
                    resize: false//禁止拉伸图形大小
                }
            }).getKendoDiagram();

            //双击点击事件
            $("#diagram").dblclick(function () {
                alert("oh,你双击了我！");
            });

            //更新图形属性
            function updateShapeProperties(shape) {
                $("#shapeBackgroundColorPicker").getKendoColorPicker().value(kendo.parseColor(shape.background));
                $("#shapeStrokeColorPicker").getKendoColorPicker().value(kendo.parseColor(shape.stroke.color));
                $("#shapeStrokeWidth").getKendoNumericTextBox().value(shape.stroke.width);
                $("#shapeWidth").getKendoNumericTextBox().value(shape.width);
                $("#shapeHeight").getKendoNumericTextBox().value(shape.height);
                $("#shapePositionX").getKendoNumericTextBox().value(shape.x);
                $("#shapePositionY").getKendoNumericTextBox().value(shape.y);
            }

            //更新连接线属性
            function updateConnectionProperties(shape) {
                $("#connectionStartCap").getKendoDropDownList().value(shape.startCap);
                $("#connectionEndCap").getKendoDropDownList().value(shape.endCap);
            }

            //左侧折叠窗格
            $("#shapesPanelBar").kendoPanelBar({
                expandMode: "multiple"
            }).getKendoPanelBar().expand(">li", false);
            //右侧折叠窗格
            $("#configurationPanelBar").kendoPanelBar({
                expandMode: "multiple"
            }).getKendoPanelBar().expand(">li", false);
            //颜色选择器
            $(".colorPicker").kendoColorPicker({
                value: "#ffffff",
                buttons: false
            });
            //画布布局属性下拉框
            $("#canvasLayout").kendoDropDownList({
                dataTextField: "text",
                dataValueField: "value",
                dataSource: [
                    { value: "TreeDown", text: "Tree Down" },
                    { value: "TreeUp", text: "Tree Up" },
                    { value: "TreeLeft", text: "Tree Left" },
                    { value: "TreeRight", text: "Tree Right" },
                    { value: "RadialTree", text: "Radial Tree" },
                    { value: "TipOverTree", text: "Tip-Over Tree" },
                    { value: "LayeredHorizontal", text: "Layered Horizontal" },
                    { value: "LayeredVertical", text: "Layered Vertical" },
                    { value: "ForceDirected", text: "Force directed" },
                    { value: "MindmapVertical", text: "Mindmap Vertical" },
                    { value: "MindmapHorizontal", text: "Mindmap Horizontal" }
                ]
            });

            //连接线开始上限下拉框
            $("#connectionStartCap").kendoDropDownList({
                dataTextField: "text",
                dataValueField: "value",
                dataSource: [
                    { value: "None", text: "None" },
                    { value: "ArrowStart", text: "Arrow Start" },
                    { value: "ArrowEnd", text: "Arrow End" },
                    { value: "FilledCircle", text: "Filed Circle" }
                ]
            });

            //连接线结束下限下拉框
            $("#connectionEndCap").kendoDropDownList({
                dataTextField: "text",
                dataValueField: "value",
                dataSource: [
                    { value: "None", text: "None" },
                    { value: "ArrowStart", text: "Arrow Start" },
                    { value: "ArrowEnd", text: "Arrow End" },
                    { value: "FilledCircle", text: "Filed Circle" }
                ]
            });

            //更新示意图调整大小
            function updateSliderIndicator(e) {
                $("#diagramZoomIndicator").attr("value", e.value);

                diagram.zoom(e.value / 100);
            }

            //示意图滑块大小
            $("#diagramZoom").kendoSlider({
                min: 10,
                max: 200,
                value: 100,
                smallStep: 10,
                largeStep: 50,
                tickPlacement: "none",
                showButtons: false,
                change: updateSliderIndicator,
                slide: updateSliderIndicator
            });

            //数值变量控件
            $(".numeric").kendoNumericTextBox();

            //设置窗口大小
            $("#window").kendoWindow({
                visible: false,
                width: 800,
                resizable: false,
                title: "About"
            });

            //点击关于时的弹窗
            $("#about").click(function() {
                $("#window").getKendoWindow().center().open();
            });

            //图形窗格条拖动设置
            $("#shapesPanelBar .shapeItem").kendoDraggable({
                hint: function() {
                    return this.element.clone();//从左侧窗格把元素复制过来
                }
            });

            //从左侧窗格把图形拖拽完成后触发
            $("#diagram").kendoDropTarget({
                drop: function(e) {
                    var item, pos, transformed;//定义
                    if (e.draggable.hint) {
                        item = e.draggable.hint.data("shape");
                        pos = e.draggable.hintOffset;
                        pos = new Point(pos.left, pos.top);
                        var transformed = diagram.documentToModel(pos);
                        item.x = transformed.x;
                        item.y = transformed.y;

                        //console.log(item);
                        diagram.addShape(item);//获取具体数据更改位置
                    }
                }
            });
        });
    </script>
</body>
</html>
